:imagesdir: images/
:revealjs_conference_logo: jbcnconf/duke.png
:speaker: Charles Moulliard (@cmoulliard)
:speaker-title: Committer, Coder, Architect
:speaker-email: cmoulliard@redhat.com
:speaker-blog: http://cmoulliard.github.io
:speaker-twitter: http://twitter.com/cmoulliard[@cmoulliard]
:talk-speaker: {speaker}
:talk-name: Security enforcement of Microservices with API Management
:talk-date: 17 June 2016

[#cover,data-background-color="#F8F8F8"]
== {blank-space}

[#block,left="700px",top="300px"]
image:{revealjs_conference_logo}[width="98%"]

[#cover-h1,width="600px",left="0px",top="180px"]
{talk-name}

[#cover-h2,width="800px",left="0px",top="500px"]
{speaker} +
{talk-date}

// ************** who - charles ********
[#who]
== Who

* {speaker-title}

* Work on Apache Camel, Karaf, Fabric8, Hawtio, Apiman, Drools

* Mountain Biker, Belgian Beer Fan

* Blog: {speaker-blog}

* Twitter: {speaker-twitter}

* Email: {speaker-email}

// ************** Agenda ********
[#agenda]
== Agenda

* RESTfull Use case

* How to Secure the Endpoint

** Policy
** Web Container
** Api Management

* Demo

// ************** transition page ************
[#transition1, data-background-color="#F8F8F8"]
== {blank-space}

[#block,width="200px",left="70px",top="0px"]
image::{revealjs_conference_logo}[]

[#cover-h1,width="600px",left="0px",top="350px"]
*Use case description*

// ************** security - rest ************
[#security-uc]
== Use case

image:security/rest-1.png[width=95%]

// ************** security - rest ************
[#security-uc-code]
== REST Service

[source,java]
----
@GET
@Path("/customers/{id}/")
@Produces("application/xml")
@ApiOperation(value = "Find Customer by ID",
                       notes = "More notes about this method",
                       response = Customer.class)

@ApiResponses(value = {
        @ApiResponse(code = 500, message = "Invalid ID supplied"),
        @ApiResponse(code = 204, message = "Customer not found")
})

public Customer getCustomer(@ApiParam(value = "ID of Customer to fetch",
                            required = true) @PathParam("id") String id) {
    LOG.info("Invoking getCustomer, Customer id is: {}", id);

    long idNumber = Long.parseLong(id);
    Customer c = customers.get(idNumber);
    return c;
}
----

// ************** security - rest ************
[#security-uc-services]
== Api documented : Swagger

image:security/swagger-service.png[width=95%]

// ************** transition page ************
[#transition2, data-background-color="#F8F8F8"]
== {blank-space}

[#block,width="200px",left="70px",top="0px"]
image::{revealjs_conference_logo}[]

[#cover-h1,width="600px",left="0px",top="300px"]
*How to Secure ?*

// ************** security - rest ************
[#security-global]
== Level !

* Endpoint {icon-arrow-right} Framework/Policy/Interceptor

{blank-space}

* HTTP Web Container {icon-arrow-right} Handler & Constraints

{blank-space}

* Externally {icon-arrow-right} Api Manager

// ************** transition page ************
[#transition3, data-background-color="#F8F8F8"]
== {blank-space}

[#block,width="200px",left="70px",top="0px"]
image::{revealjs_conference_logo}[]

[#cover-h1,width="600px",left="0px",top="300px"]
*Endpoint Level*

// ************** security - rest ************
[#security-endpoint-level]
== Endpoint level

image:security/rest-3.png[width=95%]

// ************** security - rest ************
[#security-endpoint]
== Intercept

* Framework based    : Apache Shiro, Spring Security

image:security/apache_shiro_logo.png[]
image:security/spring_security.png[]

* Interceptor/Policy : Apache Camel, Apache CXF

image:camel/apache-camel.png[]

* JAXRS              : @Roles

// ************** security - rest ************
[#security-endpoint-code-camel]
== Camel Endpoint

* Goal {icon-arrow-right} *Extract* from the HTTP request the info needed to authenticate a user
* How  {icon-arrow-right} Use a Camel Policy to *wrap* the Route / Pipeline with a new processor

{blank-space}

.Camel Example
[source]
----
public class ShiroSecurityPolicy implements AuthorizationPolicy {

    public Processor wrap(RouteContext routeContext, final Processor processor) {
        return new ShiroSecurityProcessor(processor, this);
    }
    ...
    @Override
    public boolean process(Exchange exchange, AsyncCallback callback) {
        try {
            applySecurityPolicy(exchange);
----

// ************** security - rest ************
[#security-endpoint-code-cxf]
== CXF Endpoint

- How {icon-arrow-right} Using the *ContainerRequestFilter* JAXRS Interface
- Rely on CXF *Intercept*

{blank-space}

.CXF Example
[source]
----
@Provider
@PreMatching
public class SecurityRequestFilter implements ContainerRequestFilter {

@Override
    public void filter(final ContainerRequestContext requestContext)
                throws IOException {
...
----

// ************** transition page ************
[#transition4, data-background-color="#F8F8F8"]
== {blank-space}

[#block,width="200px",left="70px",top="0px"]
image::{revealjs_conference_logo}[]

[#cover-h1,width="600px",left="0px",top="300px"]
*Web HTTP Container*

// ************** security - rest ************
[#security-container-level]
== Web container level

image:security/rest-2.png[width=95%]

// ************** security - rest ************
[#security-handler]
== HTTP Handler

- How {icon-arrow-right} Apply *Constraints* on Web Resources path(s)

[source]
----
GET /rest/accountservice/account for User
POST /webservices/customerservices/customer for Admin
----

- Designed using *JAAS* {icon-arrow-right} JDBC, LDAP, Properties

- Could use *Roles*

// ************** security - rest ************
[#security-handler-code]
== Jetty Example

* Goal {icon-arrow-right} restrict or allow access to resources
* How {icon-arrow-right} URL requested matched with one the rule(s)

.Example
[source]
----
Constraint constraint = new Constraint();
constraint.setRoles(new String[] { "user", "admin" });

ConstraintMapping mapping = new ConstraintMapping();
mapping.setPathSpec("/say/hello/*");
mapping.setMethod("GET");
mapping.setConstraint(constraint);
----

// ************** security - rest ************
[#security-handler-role]
== With @Roles

- Allow/Deny Access to resources
- Annotations supported :
* @PermitAll, @DenyAll, @RolesAllowed
- @RolesAllowed
* List of roles permitted to access method(s) in an application
- Delegate responsibility to JAXRS Framework

.Example
[source]
----
@Path("projects")
@Produces("application/json")
public class ProjectsResource {

    @POST
    @RolesAllowed("manager")
    public Project createProject(final Project project) { ... }

    @GET
    @Path("{id}")
    public Project getProject(@PathParam("id") final Long id) { ... }
----

// ************** security - rest ************
[#security-combined-level]
== Web Secured & Policy Level

image:security/rest-4.png[width=95%]

// ************** transition page ************
[#transition5, data-background-color="#F8F8F8"]
== {blank-space}

[#block,width="200px",left="70px",top="0px"]
image::{revealjs_conference_logo}[]

[#cover-h1,width="600px",left="0px",top="300px"]
*Pros / Cons*

// ************** security - rest ************
[#security-pro-con]
== Pros - Cons

* No product lock
* Great flexibility
* Spec managed
* Intrusive
* Low Management Capability
* Difficulty to centralize

// ************** transition page ************
[#transition6, data-background-color="#F8F8F8"]
== {blank-space}

[#block,width="200px",left="70px",top="0px"]
image::{revealjs_conference_logo}[]

[#cover-h1,width="600px",left="0px",top="300px"]
*External Player*

// ************** security - rest ************
[#security-endpoint-externe]
== Api Manager

image:security/rest-4.png[width=95%]

// ************** security - rest ************
[#security-apiman-1]
== Api Man

* Goal : Externalize/Delegate security endpoint to an Api
* How : Api acts as a Proxy/Gateway matching :
- Incoming request against 1 {icon-arrow-right} Many policies
- Deliver request to a target endpoint if validation succeeds

// ************** security - rest ************
[#security-apiman-2]
== Api Man - Plugin

* Goal : Setup an Api using the Basic Auth Plugin
* How :
- Create a versioned Api for an Organisation
- Define the target endpoint using REST or SOAP
- Associate a Policy using the Basic Auth Plugin

* Supports http(s) connection with
- User/password, LDAP, JDBC

.Example
[source]
----
  "contracts" : [
    {
      "apiOrgId" : "Policy_BasicAuthStatic",
      "apiId" : "echo",
      "apiVersion" : "1.0.0",
      "policies" : [
        {
          "policyImpl" : "class:io.apiman.gateway.engine.policies.BasicAuthenticationPolicy",
          "policyJsonConfig" : "{ \"realm\" : \"Test\", \"forwardIdentityHttpHeader\" : \"X-Authenticated-Identity\", \"staticIdentity\" : { \"identities\" : [ { \"username\" : \"bwayne\", \"password\" : \"bwayne\" } ] }  }"
        }
      ]
    }
  ]
----

// ************** security - rest ************
[#security-apiman-3]
== Api Man - OpenId connect

* Goal : Authenticate a user using a Identity provider to get a token used for SSO purposes
* Authentication between Client and Identity Provider: public, secret or PKI
* JSon Web Token :
- Compact token format,
- Encode claims to be transmitted,
- Base64url encoded and digitally signed and/or encrypted

Example
[source]
----
{
  "jti": "af68fac6-fd50-4b73-bd37-5c555a8e561e",
  "exp": 1442847825,
  "nbf": 0,
  "iat": 1442847525,
  "iss": "http://localhost:8080/auth/realms/fuse",
  "aud": "fuse",
  "sub": "3591e417-7c60-4464-8714-96190c7fad92",
  "azp": "fuse",
  "session_state": "f58d5dfc-6e4c-4ad2-bd2f-70713f6b942d",
  "client_session": "f06b673f-ecbe-47f2-ba76-b6a5901d5afe",
  "allowed-origins": [],
  "resource_access": {
    "account": {
      "roles": [
        "manage-account",
        "view-profile"
      ]
    }
  },
  "name": "admin ",
  "preferred_username": "admin",
  "given_name": "admin"
}
----

// ************** security - rest ************
[#security-apiman-3]
== Api Man - Role Mapping

- Goal : Restrict/allow access to an application based on an Authorization Rule
- Should be combined with Keycloak Plugin
- How : Define a collection of Authorization rules as such

|===
|Path |Verb |Role required
|.* |PUT |Writer
|.* |GET |Reader
|===

// ************** transition page ************
[#transition7, data-background-color="#F8F8F8"]
== {blank-space}

[#block,width="200px",left="70px",top="0px"]
image::{revealjs_conference_logo}[]

[#cover-h1,width="600px",left="0px",top="300px"]
*Pros / Cons*

// ************** security - rest ************
[#security-pro-con-external]
== Pros - Cons

* Centralized governance policy configuration
* Loose coupling
* Tracking of APIs and consumers of those APIs
* Gathering statistics/metrics
* Service Discovery
* Simplify security audit
* Performance
* New Architecture Brick
* Features = plugins available {icon-exclamation-mark}

// ************** security - rest ************
[#security-micro]
== Microservices

image:security/rest-5.png[width=95%]

// ************** transition page ************
[#transition8, data-background-color="#F8F8F8"]
== {blank-space}

[#block,width="200px",left="70px",top="0px"]
image::{revealjs_conference_logo}[]

[#cover-h1,width="600px",left="0px",top="300px"]
*Demo*

// *********************************
[#questions]
== Questions

[#block,top="200px",left="590px"]
image:{revealjs_conference_logo}[width="70%"]

[.noredheader,cols="65,.<45"]
|===

.2+|image:speaker/questions.png[width="95%",height="95%"]
a|* Twitter : *{speaker-twitter}*
|===

* Apiman : *http://apiman.io*, Fabric8 : *http://fabric8.io*